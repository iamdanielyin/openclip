<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>测试页面</title>
  <style type="text/css">
    body {
      margin: 0 auto;
    }

    #clipboard-value {
      width: 500px;
    }
  </style>
  <script src="assets/socket.io.js"></script>
</head>

<body>
  <input type="text" id="uid" placeholder="请输入用户ID" value="ibird" />
  <button onclick="login()">登录</button>
  <div id="clipboard-value"></div>
  <script>
    function login() {
      const uid = document.getElementById('uid').value;
      if (!uid) {
        alert('用户ID不能为空');
        return;
      }
      const client = io('http://localhost:4000');
      client.on('connect', function () {
        client.emit('login', uid);
        console.log(`客户端 ${client.id} 连接成功！`);
        alert(`客户端 ${client.id} 连接成功！`);

        document.addEventListener('paste', function (e) {
          for (const item of e.clipboardData.items) {
            if (/image\//.test(item.type)) {
              // 图片
              const blob = item.getAsFile();
              if (blob) {
                const reader = new FileReader();
                reader.onload = function (e) {
                  client.emit(`${uid}:copy_or_cut`, this.result);
                }
                reader.readAsArrayBuffer(blob);
              }


            } else if (/text\//.test(item.type)) {
              // 文本
              const text = e.clipboardData.getData(item.type);
              client.emit(`${uid}:copy_or_cut`, text);
            }
          }
          e.preventDefault();
        });

        client.on(`${uid}:paste`, function (data) {
          console.log(`${uid}:paste`);
          if (data instanceof ArrayBuffer) {
            const blob = new Blob([data]);
            if (blob) {
              const URL = window.URL || window.webkitURL;
              const source = URL.createObjectURL(blob);
              let img = document.getElementById('clipboard-img');
              if (!img) {
                img = document.createElement('img');
                img.setAttribute('id', 'clipboard-img');
                img.setAttribute('style', 'max-width:500px;');
              }
              img.setAttribute('src', source);
              document.body.appendChild(img);
            }
          } else {
            document.getElementById('clipboard-value').innerHTML = data;
          }
        });
      });
    }
    login();
  </script>
</body>

</html>